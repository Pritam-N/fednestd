# values-kafka-prod.yaml
# Optimized for Bitnami Kafka v32+ (KRaft Mode)

# -----------------------------------------------------------------------------
# General Setup (KRaft)
# -----------------------------------------------------------------------------
# In KRaft mode, nodes can be 'controller', 'broker', or both.
# We configure 'controller' to act as both (combined mode) for a standard 3-node cluster.
controller:
  replicaCount: 3
  controllerOnly: false   # Acts as both Broker and Controller
  minId: 0

  # Resources (Moved from root)
  resources:
    requests:
      cpu: "1"
      memory: "4Gi"
    limits:
      cpu: "4"
      memory: "16Gi"

  # Persistence (Moved from root)
  persistence:
    enabled: true
    size: 5Gi
    # storageClass: "fast-ssd"

  # Kafka Configuration (Moved from root-level keys to config block)
  # Kafka config format: proper.property.name=value
  config: |
    log.retention.hours=168
    log.retention.bytes=53687091200
    # Add any other server.properties overrides here

# -----------------------------------------------------------------------------
# TLS & Authentication
# -----------------------------------------------------------------------------
# Note: The deploy script overrides some of these via --set, but defining them
# here ensures the configuration is consistent.

tls:
  type: PEM
  existingSecret: kafka-tls
  pemChainIncluded: true
  # Disable auto-generation since we use our own cert-manager certificate
  autoGenerated:
    enabled: false
  # Let chart auto-generate JKS passwords (it converts PEM to JKS internally for Java)

listeners:
  client:
    protocol: SSL
    sslClientAuth: required  # Internal mTLS enforcement
  controller:
    protocol: SSL
    sslClientAuth: required
  interbroker:
    protocol: SSL
    sslClientAuth: required
  external:
    protocol: SSL

# -----------------------------------------------------------------------------
# Networking
# -----------------------------------------------------------------------------
service:
  type: ClusterIP
  ports:
    client: 9092
    controller: 9093
    interbroker: 9094

# -----------------------------------------------------------------------------
# Provisioning Job
# -----------------------------------------------------------------------------
# Disabled for now - topics can be created separately after Kafka is running
# The provisioning job has complex TLS password requirements that conflict with PEM certs
provisioning:
  enabled: false

# -----------------------------------------------------------------------------
# High Availability
# -----------------------------------------------------------------------------
# Note: In v32+, PDB configuration moved under 'controller'
controller:
  pdb:
    create: true
    minAvailable: ""
    maxUnavailable: 1

  # Affinity settings also moved under 'controller'
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            labelSelector:
              matchLabels:
                app.kubernetes.io/name: kafka
                app.kubernetes.io/component: controller-eligible
            topologyKey: "kubernetes.io/hostname"

# -----------------------------------------------------------------------------
# Metrics
# -----------------------------------------------------------------------------
metrics:
  # JMX Exporter (Java metrics)
  jmx:
    enabled: true
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 200m
        memory: 256Mi
  
  # ServiceMonitor for Prometheus Operator
  # Disabled until Prometheus Operator CRDs are installed
  serviceMonitor:
    enabled: false